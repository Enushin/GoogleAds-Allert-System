# アーキテクチャ設計ドラフト

## 1. システム概要
本システムはGoogle Ads APIから日次費用データを取得し、日本時間に基づく予測ロジックを実行した後、指定された通知チャンネル（例：Slack）へメッセージを送信する。スケジューラにより1日複数回の処理を自動化し、ログと設定管理によって運用の再現性と安全性を担保する。

## 2. コンポーネント構成
- **Google Ads APIクライアント**: 認証情報を使用して費用データを取得するモジュール。API呼び出しの再試行、レスポンス整形を担当。
- **データリポジトリ層**: APIレスポンスから必要な指標（費用、期間）を抽出し、アプリ内部で扱いやすいデータ構造へ変換する。
- **予測エンジン**: 現在時刻、経過時間、取得費用を入力として単純比例計算を実行し、当日24時の着地予測と月間ペース指標を算出する。
- **スケジューラ**: ユーザー設定のタイムテーブル（cron表現やISO8601）を解釈し、予測処理をトリガーする。タイムゾーン対応のジョブ管理を行う。
- **通知ハンドラ**: メッセージテンプレートを適用し、SlackなどのWebhookにPOSTする。送信失敗時の再試行とログ記録を行う。
- **設定マネージャ**: 環境変数または設定ファイルからAPI認証情報、予算値、スケジュール、通知先URLを読み込み、アプリへ提供する。
- **ロギング/監視**: 処理開始・終了、APIレスポンスサマリ、計算結果、通知結果、エラーを記録する。構造化ログ（JSON）を推奨。

## 3. データフロー
1. スケジューラが設定された日本時間のタイミングでジョブを実行。
2. APIクライアントがGoogle Ads APIから当日費用データを取得。
3. データリポジトリ層がレスポンスから必要指標を抽出し、予測エンジンへ渡す。
4. 予測エンジンが当日24時の着地予測と月間ペースを計算。
5. 通知ハンドラが結果を整形し、Webhookへ送信。
6. 各ステップでロギングが行われ、失敗時は再試行またはエラー通知を実施。

## 4. 技術スタック候補
- 言語: Python 3.11 以降
- フレームワーク: スケジューリングにAPSchedulerまたはCelery（シンプル構成ならAPScheduler）
- 通信: Google Ads API Python Client Library, HTTPX/Requests
- 通知: Slack Incoming Webhook（JSON POST）
- ログ: Python標準logging + 構造化出力（jsonlogger）
- インフラ: Dockerコンテナ化、GitHub ActionsによるCI（lint/test）

## 5. 設定とシークレット管理
- 認証情報やWebhook URLは.envファイルまたはSecret Managerから読み込む。
- 設定値はPydanticやdataclassesでスキーマ化し、バリデーションを実行する。
- 設定変更は環境変数または設定ファイル再読み込みで反映可能とする。

## 6. エラーハンドリングとリトライ戦略
- API呼び出し: HTTPステータス・gRPCステータスを検査し、指数バックオフで最大3回リトライ。
- 通知送信: 一時的なHTTPエラー（429/5xx）は再試行、恒久的エラーはログと警告通知。
- タイムゾーン: pytz/zoneinfoを用いてAsia/Tokyoを明示し、日付変更線付近のテストを行う。

## 7. 観測性
- ログ出力にリクエストID/ジョブIDを含め、トレーサビリティを担保。
- メトリクス例: API呼び出し成功率、処理時間、通知成功率、エラー件数。
- 監視ダッシュボードやアラート連携は将来的な拡張余地として設計に含める。

## 8. テスト戦略
- 単体テスト: APIクライアント、予測計算、通知テンプレートをモックして検証。
- 結合テスト: スケジュール→API取得→予測→通知のフローをモック環境で実行。
- E2Eテスト（任意）: サンドボックスアカウントを用いた実API呼び出しと通知送信。

## 9. デプロイ/運用
- Dockerイメージをビルドし、スケジューラを常駐させる（例：AWS ECS、Cloud Run、VM上のsystemd）。
- CI/CDでコード整形、テストを自動化。mainブランチへのマージでデプロイをトリガー。
- ロールバック手順: 前バージョンのコンテナへ切り戻し、設定はバージョン管理。

## 10. 今後の拡張
- 月間着地予測の高度化（トレンド反映）。
- 複数アカウントやキャンペーン粒度でのレポーティング。
- Teamsやメールなど他チャネルへの通知拡張。

