---
title: "障害対応ランブック"
status: "Draft"
version: "0.1.0"
language: "ja"
---

# 障害対応ランブック

本ドキュメントは Google Ads 予算アラートシステムで障害が発生した際の標準対応手順とエスカレーションフローを定義する。検知から復旧、事後振り返りまでの流れを統一することで、通知未達や予測エラーの影響を最小化することが目的である。

## 役割と連絡体制

| 役割 | 主担当 | 連絡方法 | 予備担当 |
| --- | --- | --- | --- |
| 值班オーナー（Primary） | SRE/運用担当 | 障害用 Slack チャンネル `#ads-alert-oncall` | プロダクトエンジニア |
| エスカレーション先 | プロダクトマネージャー | Slack DM / 電話 | - |
| 外部サポート | Google Ads API サポート窓口 | サポートチケット | - |

- 值班ローテーションは `oncall_schedule.yaml` で週次更新する。
- 重大度が `SEV-2` 以上の場合、10分以内にエスカレーション先へ状況を共有する。

## 障害分類（Severity）

| レベル | 目安 | 例 |
| --- | --- | --- |
| SEV-1 | 主要機能停止、通知全停止、代替手段なし | Slack 通知が全件失敗、スケジューラが起動しない |
| SEV-2 | 重要機能劣化、主要アカウントに影響 | 一部アカウントの API 取得失敗が継続、予測結果が更新されない |
| SEV-3 | 限定的な不具合、利用回避策あり | 単発実行コマンドでのみエラー、通知文言フォーマット崩れ |
| SEV-4 | 監視/改善タスク | 再現頻度が低い軽微な警告 |

初動担当者は状況を確認後、上表に従って重大度を宣言し Slack の障害スレッドに記録する。

## 初動フロー（標準手順）

1. **検知**: アラートシステム、ユーザー報告、ログ監視のいずれかで障害を認知した時点で PagerDuty / Slack へステータスを投稿する。
2. **アサイン**: 值班オーナーが 5 分以内に対応を表明し、重大度を仮決定する。
3. **状況共有**: 障害チャンネルで以下を報告する。
   - 発生時刻（JST）
   - 影響範囲（通知対象アカウント、ジョブ名）
   - 現在の重大度
   - 既知の暫定対応
4. **初期調査**: ログ・メトリクスを確認し、再現条件と暫定対処可否を判断する。
5. **エスカレーション**: SEV-2 以上の場合はプロダクトマネージャーへ、外部依存が原因と判断した場合は API サポートへ連絡する。

## 詳細対応プロセス

### 1. 原因調査
- `python -m google_ads_alert doctor` を実行し、設定・Webhook・スケジュールに異常がないか確認する。
- `python -m google_ads_alert schedule --show-next 5` でジョブが正しく登録されているかを確認する。
- `logs/` ディレクトリまたは監視基盤で `google_ads_alert` 名前空間のログを検索し、エラーとタイムスタンプを抽出する。
- Google Ads API 呼び出し失敗の場合はレスポンスコードと `request_id` を記録し、再試行ポリシーの発動状況を確認する。

### 2. 暫定対処
- 通知再送が必要な場合は `python -m google_ads_alert run --dry-run` で内容を確認後、`--dry-run` を外して手動再送する。
- スケジューラ停止時は `serve` コマンドを再起動し、起動ログを添えて報告する。
- API レートリミットが原因の場合は `GOOGLE_ADS_API_BACKOFF_MULTIPLIER` を一時的に引き上げる。
- Slack Webhook 側の障害が疑われる場合はスタックチャンネルの代替通知手段（メール / SMS）を利用する。

### 3. 復旧確認
- 直近 2 回分のスケジュール実行を監視し、成功ログと Slack 通知確認をもって復旧と判断する。
- 影響した期間・通知件数・対象アカウントを整理し、ユーザーへ報告する。

## コミュニケーション指針

- 障害スレッドはタイムライン形式で更新し、調査ステップごとに `HH:MM` の時刻を付ける。
- ユーザー報告があった場合は 15 分以内に一次返信を行い、進捗がなくとも 30 分ごとに状況を共有する。
- 外部サポートへ連絡する際は以下情報を添付する。
  - 発生時刻、`customer_id`
  - 影響するキャンペーン ID またはジョブ ID
  - エラーコード、`request_id`
  - 該当ログの抜粋（機密情報はマスク）

## エスカレーションパス

1. 值班オーナー（Primary）
2. プロダクトエンジニア（Secondary）
3. プロダクトマネージャー
4. 部門責任者（必要時）

それぞれ 10 分以内に応答がない場合は次の担当へ直接電話連絡する。

## 事後対応（Postmortem）

- 障害終了後 1 営業日以内に下記テンプレートで事後報告を作成し、`docs/incidents/` に保存する。
- 1 週間以内に振り返りミーティングを開催し、恒久対策・再発防止策を決定する。
- ドキュメント更新（設定、テスト、監視）を含めたアクションアイテムに期限と責任者を割り当てる。

### Postmortem テンプレート

```
# インシデント報告書
- 事象: 
- 発生日時 (JST): 
- 検知方法: 
- 影響範囲: 
- 重大度: SEV-
- タイムライン:
  - HH:MM: 調査開始
  - HH:MM: 原因判明
  - HH:MM: 暫定対応
  - HH:MM: 復旧確認
- 原因:
- 暫定対処:
- 恒久対策:
- 学び:
- フォローアップタスク:
```

## 参考資料

- [ログ出力ポリシー](logging_policy.md)
- [監視指標とアラート要件](monitoring_metrics.md)
- Google Ads API 障害情報: <https://ads-developers.googleblog.com/>
- Slack ステータス: <https://status.slack.com/>

