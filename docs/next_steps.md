---
title: "次のアクションプラン"
status: "Draft"
version: "0.1.0"
language: "ja"
---

# フェーズ別の次ステップ

## 直近で着手すべきタスク（優先度高）
- [x] Google Ads APIの認証情報取得プロセスを整理し、必要な資格情報を揃える。（詳細: [Google Ads API認証・通知Webhook設定ガイド](credentials_and_webhook_guide.md)）
- [x] Slackなど通知チャンネル向けWebhookの設定方法と秘匿化方針を決定する。（詳細: [Google Ads API認証・通知Webhook設定ガイド](credentials_and_webhook_guide.md)）
- [x] 日本時間ベースでのスケジュール要件を定義し、初回の計測・通知タイムテーブル案を作成する。
- [x] Google Ads APIクライアントの最小実装を設計し、タイムゾーンを考慮したテスト方針を固める。
- [x] 日次着地予測および月間ペース計算のロジックを実装し、単体テストを整備する。
- [x] 実運用を見据えた設定値読込レイヤー（.env/Secrets Manager等）の設計とダミー実装を追加する。

## 1. 仕様・設定整理
- [x] Google Ads APIの利用要件を整理し、必要な認証情報（OAuth2クライアントID、リフレッシュトークン、開発者トークンなど）の取得手順をまとめる。
- [x] 通知チャンネル（例: Slack）のWebhook URLや認証方式を確認し、セキュアな保管方法（環境変数、シークレットマネージャ等）を決定する。
- [x] 日本時間でのスケジューリング要件を明文化し、日内の計測・通知タイミングのサンプルスケジュールを定義する。
    - サンプル: 08:00 / 14:00 / 20:00（1日3回、主要時間帯に集中）

## 2. アーキテクチャ設計
- [x] Google Ads APIクライアント、スケジューラ、予測ロジック、通知モジュールの責務分離を図るクラス／モジュール設計を行う。
- [x] 設定ファイル形式（YAML/JSON/.envなど）と読み込みフローを決定し、ローカル・本番双方で共通利用できる構成案を作成する。
- [x] エラーハンドリングとリトライ戦略（指数バックオフ、最大試行回数など）を各コンポーネントで統一的に扱うための設計方針を策定する。
    - `GoogleAdsCostService` に `RetryConfig` を導入し、再試行回数・待機秒数・対象例外を設定可能にした。
- [x] ロギング／監視の責務を担う共通ユーティリティ層のインターフェース案をまとめる。
    - `google_ads_alert.logging_utils` でタイムゾーン考慮済みのロガー初期化関数と子ロガー取得関数を提供した。

## 3. 実装準備
- [x] Google Ads APIライブラリおよび通知チャンネル向けSDK/HTTPクライアントの導入要否を評価し、必要な依存関係リストを確定する。
- [x] 環境変数ベースの設定テンプレートとサンプル `.env` を用意し、Secrets共有手順を追記する。
- [x] テスト戦略（単体・結合・E2E）に基づき、モック・スタブの利用方針とテストデータ準備手順を整備する。（詳細: [テスト戦略と検証手順](testing_strategy.md)）
- [x] ローカル開発環境でのcron/scheduler相当の実行方法を決定し、擬似スケジューリングの検証方法を明文化する。（詳細: [テスト戦略と検証手順](testing_strategy.md#2-ローカルスケジューラ検証手順)）
- [x] Google Ads APIのサンドボックス／mock transportを利用した統合テスト実行手順を文書化する。（詳細: [テスト戦略と検証手順](testing_strategy.md#3-google-ads-api-サンドボックスmock-transport)）

## 4. MVP実装ロードマップ
- [x] Google Ads APIから日次費用データを取得する最小限のAPIクライアントを作成し、日付・タイムゾーン処理の単体テストを用意する。
- [x] 取得データを基に当日24時の着地予測を算出するBudget Predictorのプロトタイプを作成し、単純比例ロジックのテストを整備する。
- [x] 通知テンプレート（本文構成、メトリクス表示フォーマット）を定義し、Slack等へメッセージ送信するNotification Handlerを実装する。
- [x] スケジューラ（APSchedulerやCloud Scheduler等）を活用し、ユーザー指定時刻でのジョブ実行を実現する。
    - `google_ads_alert serve` コマンドを追加し、`.env` から読み込んだスケジュール設定に基づき Cron トリガーで日次ジョブを登録する `BlockingScheduler` 初期化ロジックを実装した。
    - APScheduler が利用できない環境でもカスタムスケジューラを差し替えられるよう、`SchedulerFactory` プロトコルを用意してテスト可能性を確保した。
- [x] Combined forecast結果を通知フォーマットへ統合し、UI／メッセージ例を作成する。
    - `workflow.py` にスナップショット作成とSlackペイロード送信ユーティリティを追加し、`build_slack_notification_payload` を利用した通知処理を一元化した。
- [x] プロジェクト全体の設定検証コマンド（`python -m google_ads_alert doctor`）を実装し、運用前セルフチェック手順を整備する。
    - `google_ads_alert.cli.run_doctor` で環境変数または `.env` ファイルから設定を読み込み、Webhook・予算設定・スケジュール生成を検証できるようになった。
    - `python -m google_ads_alert schedule` で設定済みスケジュールの今後の実行時刻を日本語タイムゾーンに合わせて確認できるプレビュー機能を追加した。
- [x] 単発実行用のCLI（`python -m google_ads_alert run`）を実装し、API問い合わせからSlack送信までの一連のフローを検証できるようにする。
    - `run_once` で `GOOGLE_ADS_TRANSPORT` 経由のカスタムトランスポートを組み込み、`--dry-run` ではSlack送信をスキップしてペイロードを表示できる。
    - Slack送信ファクトリも `SLACK_SENDER_FACTORY` で差し替え可能とし、Webhookが利用できない環境でもJSON出力で確認できる。

## 5. 運用と監視
- [x] ログ出力ポリシー（ログレベル、フォーマット、出力先）を定義し、主要イベントとエラートレースを確実に記録できるよう整備する。
    - `docs/logging_policy.md` にポリシーをまとめ、CLI 各コマンドで INFO/ERROR ログと例外スタックトレースを出力するよう実装した。
- [x] 主要メトリクス（API呼び出し成功率、通知成功率、予測誤差など）の監視方法を検討し、必要なダッシュボードまたはアラート設定の要件をまとめる。
    - 詳細: [監視指標とアラート要件](monitoring_metrics.md) にメトリクス一覧、ダッシュボード構成、アラート設計を整理した。
- [x] 障害発生時の手順（再試行、手動通知、エスカレーションフロー）を策定し、運用ドキュメントとして共有する。
    - 詳細: [障害対応ランブック](incident_response_runbook.md) に標準対応フローと Postmortem テンプレートを整理した。
- [ ] SLA/SLIを定義し、AlertmanagerやPagerDuty等との連携要否を判断する。
- [ ] インシデントレビューのテンプレートを用意し、学習サイクルを明文化する。

## 6. 拡張検討
- [ ] 月間予測機能を追加する際のデータ要件と予測アルゴリズムの選択肢を洗い出し、技術調査タスクを整理する。
- [ ] 複数アカウント対応や通知チャネル追加を想定した設定項目の拡張性を評価し、設定スキーマ改善案を検討する。
- [ ] コスト効率化やリソース最適化のためのインフラ構成（サーバーレス、コンテナ化、CI/CD）を段階的に整える計画を策定する。

## 付録: スケジュール要件詳細

- 日次アラートは既定で日本時間（Asia/Tokyo）に合わせて 08:00 / 14:00 / 20:00 の3回実行する。
- 実行回数を増減する場合でも、開始・終了アンカー時刻を明示して等間隔に分割する。
- 祝日や営業時間外の運用ポリシーが定まっていないため、初期リリースでは常にスケジュールを生成し、不要な時間帯は設定で除外する。
- 設定値は `DailyScheduleConfig` で一元管理し、テストではアジア・東京以外のタイムゾーンも明示的に検証する。

## 付録: Google Ads APIクライアント設計メモ

- `google_ads_client.py` で `GoogleAdsCostService` を定義し、日次の費用集計とGAQLクエリ構築を担う。
- `GoogleAdsSearchTransport` プロトコルを導入し、テスト時にはダミー実装を差し替えることで外部依存を排除する。
- レポート期間は `build_daily_query_range` でローカル日付境界を算出し、`DailyCostSummary` として費用をマイクロ単位で保持する。
- 単体テストでは日本時間へのローカライズと費用合算を検証し、将来的なAPIエラー処理追加の足場とする。

## 付録: 設定読込ユーティリティの現状

- ルート直下に `.env.example` を追加し、Google Ads認証情報・Slack通知設定・スケジュール関連の主要キーをサンプルとして提示した。
- `google_ads_alert.config.load_env_file` で `.env` ファイルを解析し、コメント行や `export` 形式にも対応したマッピングを返す。
- `google_ads_alert.config.load_config_from_env_file` を利用することで、`.env` の値をベース環境変数とマージしながら `ApplicationConfig` を構築できる。
- Secrets Manager 等を採用する際も、マージ用の `base_env` に各種資格情報を注入する方針とする。

